<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapGo - EV Route Planner</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        body { font-family: 'Inter', sans-serif; }
        #map {
            height: 100%;
            width: 100%;
        }
        .leaflet-routing-container { display: none !important; }
    </style>
</head>

<body class="overflow-hidden bg-white">
    <div class="h-screen flex flex-col">

        <!-- Top Navbar -->
        <nav class="bg-black text-white p-4">
            <div class="flex justify-between items-center">
                <h1 class="font-bold text-lg flex items-center gap-2">
                    <i class="bi bi-lightning-charge-fill text-yellow-400"></i> ZapGo
                </h1>
                <button id="logoutBtn"
                    class="border border-white px-3 py-1 rounded hover:bg-white hover:text-black transition">
                    Logout
                </button>
            </div>
        </nav>

            <div class="flex flex-1 relative min-h-0">


            <!-- Sidebar Planning UI -->
            <div class="w-80 bg-gray-50 p-5 shadow-xl border-r z-50 overflow-y-auto h-full">

                <!-- USER PROFILE BOX -->
                <div class="flex items-center gap-3 p-3 mb-4 bg-white rounded shadow">
                    <img id="userPhoto" class="w-12 h-12 rounded-full border" />
                    <div>
                        <p id="userName" class="font-semibold text-gray-800"></p>
                        <p id="userEmail" class="text-xs text-gray-500"></p>
                    </div>
                </div>

                <label class="text-xs font-semibold text-gray-700 uppercase">Starting Point</label>
                <input id="start" class="w-full p-2 border rounded mb-3" placeholder="e.g. New Delhi">

                <label class="text-xs font-semibold text-gray-700 uppercase">Destination</label>
                <input id="end" class="w-full p-2 border rounded mb-3" placeholder="e.g. Mumbai">

                <label class="text-xs font-semibold text-gray-700 uppercase">Initial & Final Charge (%)</label>
                <div class="flex gap-2 mb-3">
                    <input type="number" id="initialCharge" placeholder="Initial %"
                        min="1" max="100" class="w-1/2 p-2 border rounded">
                    <input type="number" id="finalCharge" placeholder="Final %"
                        min="1" max="100" class="w-1/2 p-2 border rounded">
                </div>

                <label class="text-xs font-semibold text-gray-700 uppercase">Range (in km)</label>
                <input type="number" id="range" value="300" class="w-full p-2 border rounded mb-3">

                <label class="text-xs font-semibold text-gray-700 uppercase">Journey Start Time</label>
                <div class="flex gap-2 mb-3">
                    <input type="number" id="hours" placeholder="HH" min="1" max="12"
                        class="w-1/3 p-2 border rounded">
                    <input type="number" id="minutes" placeholder="MM" min="0" max="59"
                        class="w-1/3 p-2 border rounded">
                    <select id="ampm" class="w-1/3 p-2 border rounded">
                        <option value="AM">AM</option>
                        <option value="PM">PM</option>
                    </select>
                </div>

                <button id="planRoute"
    class="w-full bg-black text-white py-3 rounded font-semibold hover:bg-gray-800 transition flex items-center justify-center gap-2">
    <span id="planRouteText">Plan Route</span>
    <span id="planLoader" class="hidden animate-spin border-2 border-white border-t-transparent w-5 h-5 rounded-full"></span>
</button>


                <!-- Trip Summary Section -->
                <div id="routeDetails" class="hidden mt-5 space-y-4">
                    <div class="bg-blue-100 p-3 rounded text-blue-800">
                        <p class="font-bold text-sm"><i class="bi bi-geo-alt"></i> Trip Summary</p>
                        <p>Distance: <span id="totalDist" class="font-bold">0</span> km</p>
                        <p>Est. Time: <span id="totalTime" class="font-bold">0</span> hrs</p>
                    </div>

                    <h3 class="font-semibold text-sm">Suggested Charging Stops:</h3>
                    <div id="chargingStops" class="max-h-40 overflow-y-auto space-y-2"></div>

                    <button id="bookAll"
                        class="w-full p-3 bg-green-600 text-white rounded hover:bg-green-700 font-bold transition">
                        Confirm Booking
                    </button>
                </div>

                <!-- My Bookings section -->
                <div id="myBookings" class="mt-5 bg-white rounded-lg shadow p-3">
                <h3 class="font-semibold text-sm mb-2">My Bookings</h3>
                <div id="myBookingsList" class="space-y-2 text-xs text-gray-700">
                    <p class="text-gray-400">No bookings yet.</p>
                </div>
            </div>


            </div>

            <!-- Map Display Section -->
            <div class="flex-1 relative">
                <div id="map"></div>
            </div>

        </div>
    </div>


    <!-- Leaflet Map Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="script.js"></script>

    <!-- HERE IS THE YUVANSH FIREBASE SCRIPT -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_d-uzdhnhA_MNtLRNxI_9Cq2Eq3qpdGA",
    authDomain: "zapgo-admin-app.firebaseapp.com",
    projectId: "zapgo-admin-app",
    storageBucket: "zapgo-admin-app.firebasestorage.app",
    messagingSenderId: "109873838158",
    appId: "1:109873838158:web:b7d723030c2f447628ab1f",
    measurementId: "G-WG25REDHXT"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const bookBtn = document.getElementById("bookAll");
  const bookingsList = document.getElementById("myBookingsList");

  function renderBookings(list) {
    if (!bookingsList) return;
    bookingsList.innerHTML = "";
    list.forEach((b) => {
      const div = document.createElement("div");
      div.className = "border rounded-md px-2 py-1";
      div.innerHTML = `
        <div class="font-medium">${b.from} â†’ ${b.to}</div>
        <div class="text-xs text-gray-600">
          Distance: ${b.dist} km â€¢ Time: ${b.time} mins<br/>
          Booked at: ${b.createdAt}
        </div>
      `;
      bookingsList.appendChild(div);
    });
  }

  // restore previous bookings from localStorage
  const saved = JSON.parse(localStorage.getItem("zapgoBookings") || "[]");
  if (saved.length > 0) renderBookings(saved);

  bookBtn.addEventListener("click", async () => {
    const from = document.getElementById("start").value || "-";
    const to = document.getElementById("end").value || "-";
    const dist = document.getElementById("totalDist").innerText || "-";
    const time = document.getElementById("totalTime").innerText || "-";

    if (!from || !to || dist === "-" || time === "-") {
      alert("Please plan a route before booking.");
      return;
    }

    const booking = {
      from,
      to,
      dist,
      time,
      createdAt: new Date().toLocaleString(),
    };

    // 1 Update UI + localStorage
    const existing = JSON.parse(localStorage.getItem("zapgoBookings") || "[]");
    existing.push(booking);
    localStorage.setItem("zapgoBookings", JSON.stringify(existing));
    renderBookings(existing);

    // 2 Try Firestore and LOG everything
    //console.log("ðŸ”¥ Trying to save booking to Firestore:", booking);
    //console.log("UID going into Firestore:", localStorage.getItem("userUID"));


    try {
  const ref = await addDoc(collection(db, "bookings"), {
    uid: localStorage.getItem("userUID") || null,
    email: localStorage.getItem("userEmail") || null,
    start: from,
    destination: to,
    distance: dist,
    durationMinutes: time,
    createdAt: new Date().toISOString(),
  });
  console.log("Firestore booking saved with ID:", ref.id);
} catch (err) {
  console.error("Firestore booking save failed:", err);
}


    if (typeof showToast === "function") {
      showToast("Booking confirmed!");
    } else {
      alert("Booking confirmed!");
    }
  });
</script>


<!-- Logout button -->
 <script>
    const logoutBtn = document.getElementById("logoutBtn");

    if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
            // Clear login session
            localStorage.removeItem("userEmail");
            localStorage.removeItem("userName");
            localStorage.removeItem("userPhoto");
            localStorage.removeItem("zapgoBookings");

            // Redirect to login page
            window.location.href = "index.html"; // change if your login page is named differently
        });
    } else {
        console.error("Logout button NOT FOUND in DOM");
    }
</script>

<!-- Loader Script -->
 <script>
    // Load Google User Info into Sidebar
    document.getElementById("userName").innerText =
        localStorage.getItem("userName") || "User";

    document.getElementById("userEmail").innerText =
        localStorage.getItem("userEmail") || "";

    document.getElementById("userPhoto").src =
        localStorage.getItem("userPhoto") ||
        "https://via.placeholder.com/100";

    // Attach loading animation to Plan Route button
    const btn = document.getElementById("planRoute");
    const text = document.getElementById("planRouteText");
    const loader = document.getElementById("planLoader");

    window.startRouteLoading = function () {
        btn.disabled = true;
        text.classList.add("hidden");
        loader.classList.remove("hidden");
    };

    window.stopRouteLoading = function () {
        btn.disabled = false;
        text.classList.remove("hidden");
        loader.classList.add("hidden");
    };
</script>


<!-- Toast Notif added -->
<div id="toast"
    class="fixed bottom-5 right-5 p-4 rounded shadow-lg hidden text-white font-semibold z-[2000] transition">
</div>

<script>
    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.innerText = message;

        toast.classList.remove("hidden");

        if (type === "success") toast.style.background = "#16a34a"; // green
        if (type === "error") toast.style.background = "#dc2626";   // red

        setTimeout(() => {
            toast.classList.add("hidden");
        }, 2500);
    }
</script>

</body>

</html>
